<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Product Lookup – CODE Search</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .glass { background: rgba(255,255,255,0.65); backdrop-filter: blur(10px); }
    .focus-ring:focus { outline: none; box-shadow: 0 0 0 4px rgba(37,99,235,0.25); }
    .shine { position: relative; overflow: hidden; }
    .shine::after { content: ""; position: absolute; top:0; left:-150%; width:50%; height:100%; transform: skewX(-20deg); background: linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent); animation: slide 2s ease-in-out infinite; }
    @keyframes slide { 0% { left: -150%; } 60% { left: 200%; } 100% { left: 200%; } }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-100 to-slate-200 text-slate-800">
  <div class="max-w-xl mx-auto px-4 py-8">
    <header class="mb-6">
      <h1 class="text-2xl font-semibold tracking-tight">Product Lookup</h1>
      <p class="text-sm text-slate-500">ค้นหาด้วยรหัสสินค้า (CODE)</p>
    </header>

    <div class="glass rounded-2xl p-4 shadow-lg border border-white/50">
      <div class="flex gap-2">
        <input id="q" type="text" inputmode="text" autocomplete="off"
               placeholder="พิมพ์/สแกน CODE แล้วกด Enter หรือปุ่มค้นหา"
               class="w-full px-4 py-3 rounded-xl border border-slate-200 focus-ring text-base" />
        <button id="clear" class="px-3 py-3 rounded-xl bg-white border border-slate-200 hover:bg-slate-50 active:scale-[.98] transition" title="ล้างค่า">ล้าง</button>
        <button id="scan"  class="px-3 py-3 rounded-xl bg-white border border-slate-200 hover:bg-slate-50 active:scale-[.98] transition" title="สแกนบาร์โค้ด">สแกน</button>
        <button id="btn"
          class="inline-flex items-center justify-center h-12 px-6 rounded-xl bg-black text-white
                 text-base font-semibold leading-none text-center hover:opacity-90 active:scale-[.98]
                 transition shine">ค้นหา</button>
      </div>
      <div class="mt-2 text-xs text-slate-500">
        รองรับ Handheld/Tablet, การยิงบาร์โค้ด และกล้อง (ต้องเปิดผ่าน HTTPS และใน Safari โดยตรง ไม่ใช่ in-app browser)
      </div>
    </div>

    <section id="result" class="mt-6"></section>

    <section class="mt-6 grid gap-4">
      <div class="glass rounded-2xl p-4 shadow border border-white/50">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold">ประวัติการค้นหา</h2>
          <button id="clearHist" class="text-xs text-slate-500 underline">ล้างประวัติ</button>
        </div>
        <ul id="histList" class="mt-3 space-y-2 text-sm"></ul>
      </div>
    </section>
  </div>

  <div id="scanOverlay" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-md p-4 relative">
      <button id="closeScan" class="absolute right-3 top-3 text-slate-400">✕</button>
      <div class="mb-2 text-sm text-slate-600">เล็งกล้องไปที่บาร์โค้ด</div>
      <video id="video" autoplay playsinline muted class="w-full rounded-lg bg-black"></video>
      <canvas id="canvas" class="hidden"></canvas>
      <div class="text-xs text-slate-500 mt-2">ถ้าอุปกรณ์ไม่รองรับ จะใช้ jsQR/Quagga ให้อัตโนมัติ</div>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwrKgKw0JFqwQX4-0sL90paBc4BLDPOiQyyWEUOx9MTetLfiUlabG1y6igSa-91RD-L/exec";

    // ===== Utils =====
    function digitsOnly(s){ return String(s ?? '').replace(/\D+/g,''); }
    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
    function escapeAttr(s){ return String(s).replace(/'/g,'&#39;'); }
    function normalizeCode(raw) {
      const s = digitsOnly(raw).trim();
      return (s.length >= 11) ? s.slice(4, 11) : s;
    }
    function formatPrice(value) {
      const num = parseFloat(String(value).replace(/[^\d.\-]/g, ''));
      return Number.isNaN(num) ? '' : num.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    function formatPercent(value) {
      if (value == null || value === '') return '';
      let s = String(value).trim();
      const hasPercent = s.includes('%');
      const num = parseFloat(s.replace(/[^\d.\-]/g, ''));
      if (Number.isNaN(num)) return s;
      let pct = hasPercent ? num : (num <= 1 ? num * 100 : num);
      const r = Math.round(pct * 100) / 100;
      return (Number.isInteger(r) ? r.toString() : r.toFixed(2)) + '%';
    }
    
    // ===== คำนวณราคาส่วนลด =====
    function calculateDiscountedPrice(originalPrice, promotion) {
      const price = parseFloat(String(originalPrice).replace(/[^\d.]/g, ''));
      const promoPercent = parseFloat(String(promotion).replace(/[^\d.]/g, ''));
      if (Number.isNaN(price) || Number.isNaN(promoPercent)) {
        return null;
      }
      const discount = (promoPercent > 1) ? (promoPercent / 100) : promoPercent;
      return price * (1 - discount);
    }

    // ===== History =====
    const LS_KEY_HIST = 'lookup_history_v2';
    const getHist = () => JSON.parse(localStorage.getItem(LS_KEY_HIST) || '[]');
    const setHist = (arr) => localStorage.setItem(LS_KEY_HIST, JSON.stringify(arr.slice(0,50)));
    function renderHist(){
      const ul = document.getElementById('histList');
      const hist = getHist();
      ul.innerHTML = hist.map(({code, description}) =>
        `<li><button class="underline" onclick="quickSearch('${escapeAttr(code)}')">${escapeHtml(code)}${description ? ' — ' + escapeHtml(description) : ''}</button></li>`
      ).join('') || '<li class="text-slate-400">— ไม่มี —</li>';
    }
    function addHist(entry){
      const e = { code: entry.code || '', description: entry.description || '' };
      if (!e.code) return;
      const hist = getHist();
      const idx = hist.findIndex(x => (x.code || '').toLowerCase() === e.code.toLowerCase());
      if (idx !== -1) hist.splice(idx,1);
      hist.unshift(e);
      setHist(hist);
      renderHist();
    }

    // ===== UI Builders =====
    function buildCard(d) {
      const code = d.CODE || '';
      const desc = d.DESCRIPTION || '';
      const cate = d.CATEGORY || ''; // เพิ่ม CATE
      const originalPrice = formatPrice(d.ORIGINAL_PRICE); // เพิ่ม ราคาก่อนลด
      const promo = formatPercent(d['PROMOTION(CF)']);
      const promoCode = d['PROMO CODE'] || '';
      const discountedPrice = calculateDiscountedPrice(d.ORIGINAL_PRICE, d['PROMOTION(CF)']);

      return `
        <div class="glass rounded-2xl p-5 shadow-lg border border-white/50">
          <div class="grid grid-cols-1 gap-3">
            <div><div class="text-xs uppercase tracking-wide text-slate-500">CODE</div><div class="text-lg font-semibold">${escapeHtml(code)}</div></div>
            <div><div class="text-xs uppercase tracking-wide text-slate-500">DESCRIPTION</div><div class="text-base">${escapeHtml(desc)}</div></div>
            <div><div class="text-xs uppercase tracking-wide text-slate-500">CATEGORY</div><div class="text-base">${escapeHtml(cate)}</div></div>
            <div>
              <div class="text-xs uppercase tracking-wide text-slate-500">PROMOTION(CF)</div>
              <div class="text-base font-bold text-red-600">${escapeHtml(promo)}</div>
            </div>
            ${promoCode ? `<div><div class="text-xs uppercase tracking-wide text-slate-500">PROMO CODE</div><div class="text-base">${escapeHtml(promoCode)}</div></div>` : ''}
            
            <div class="mt-4">
              <div class="text-xs uppercase tracking-wide text-slate-500">PRICE</div>
              <div class="flex items-end gap-2">
                ${originalPrice ? `<div class="text-lg text-slate-400 line-through">${originalPrice}</div>` : ''}
                ${discountedPrice !== null ? `<div class="text-2xl font-bold text-red-600">${formatPrice(discountedPrice)} บาท</div>` : ''}
              </div>
            </div>

          </div>
        </div>`;
    }
    
    // โค้ดส่วนอื่นๆ ...
    function showLoading(){
      document.getElementById('result').innerHTML = `
        <div class="glass rounded-2xl p-5 shadow-lg border border-white/50 animate-pulse">
          <div class="h-4 bg-slate-200 rounded w-24 mb-4"></div>
          <div class="space-y-3">
            <div class="h-6 bg-slate-200 rounded"></div>
            <div class="h-6 bg-slate-200 rounded"></div>
            <div class="h-6 bg-slate-200 rounded"></div>
            <div class="h-6 bg-slate-200 rounded"></div>
            <div class="h-6 bg-slate-200 rounded"></div>
          </div>
        </div>`;
    }
    function showEmpty(msg='ไม่พบข้อมูล'){
      document.getElementById('result').innerHTML = `<div class="text-center text-slate-500">${msg}</div>`;
    }
    
    async function search(q){
      const code = normalizeCode(q);
      if (!code) { showEmpty('กรุณาพิมพ์ CODE'); return; }
      showLoading();
      try{
        const url = new URL(API_URL);
        url.searchParams.set('q', code);
        const res = await fetch(url.toString(), { cache: 'no-store' });
        const json = await res.json();
        if (json && json.data) {
          const d = json.data;
          document.getElementById('result').innerHTML = buildCard(d);
          addHist({ code: d.CODE || '', description: d.DESCRIPTION || '' });
        } else {
          showEmpty('ไม่พบข้อมูล หรือ CODE นี้ไม่ร่วม PRO Clearance');
        }
      } catch(e){
        console.error(e);
        showEmpty('เกิดข้อผิดพลาดในการดึงข้อมูล');
      }
    }

    // โค้ดส่วนอื่นๆ ...

    // init
    renderHist();
  </script>
</body>
</html>


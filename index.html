<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Product Lookup – CODE Search</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fallback สำหรับ 1D barcode -->
  <script defer src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
  <!-- Fallback สำหรับ QR บน iPhone -->
  <script defer src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <style>
    .glass { background: rgba(255,255,255,0.65); backdrop-filter: blur(10px); }
    .focus-ring:focus { outline: none; box-shadow: 0 0 0 4px rgba(37,99,235,0.25); }
    .shine { position: relative; overflow: hidden; }
    .shine::after { content: ""; position: absolute; top:0; left:-150%; width:50%; height:100%; transform: skewX(-20deg); background: linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent); animation: slide 2s ease-in-out infinite; }
    @keyframes slide { 0% { left: -150%; } 60% { left: 200%; } 100% { left: 200%; } }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-100 to-slate-200 text-slate-800">
  <div class="max-w-xl mx-auto px-4 py-8">
    <header class="mb-6">
      <h1 class="text-2xl font-semibold tracking-tight">Product Lookup</h1>
      <p class="text-sm text-slate-500">ค้นหาด้วยรหัสสินค้า (CODE)</p>
    </header>

    <div class="glass rounded-2xl p-4 shadow-lg border border-white/50">
      <div class="flex gap-2">
        <input id="q" type="text" inputmode="text" autocomplete="off"
               placeholder="พิมพ์/สแกน CODE แล้วกด Enter หรือปุ่มค้นหา"
               class="w-full px-4 py-3 rounded-xl border border-slate-200 focus-ring text-base" />
        <button id="clear" class="px-3 py-3 rounded-xl bg-white border border-slate-200 hover:bg-slate-50 active:scale-[.98] transition" title="ล้างค่า">ล้าง</button>
        <button id="scan"  class="px-3 py-3 rounded-xl bg-white border border-slate-200 hover:bg-slate-50 active:scale-[.98] transition" title="สแกนบาร์โค้ด">สแกน</button>
        <button id="btn"
          class="inline-flex items-center justify-center h-12 px-6 rounded-xl bg-black text-white
                 text-base font-semibold leading-none text-center hover:opacity-90 active:scale-[.98]
                 transition shine">ค้นหา</button>
      </div>
      <div class="mt-2 text-xs text-slate-500">
        รองรับ Handheld/Tablet, การยิงบาร์โค้ด และกล้อง (ต้องเปิดผ่าน HTTPS และใน Safari โดยตรง ไม่ใช่ in-app browser)
      </div>
    </div>

    <section id="result" class="mt-6"></section>

    <section class="mt-6 grid gap-4">
      <div class="glass rounded-2xl p-4 shadow border border-white/50">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold">ประวัติการค้นหา</h2>
          <button id="clearHist" class="text-xs text-slate-500 underline">ล้างประวัติ</button>
        </div>
        <ul id="histList" class="mt-3 space-y-2 text-sm"></ul>
      </div>
    </section>
  </div>

  <!-- Scan overlay -->
  <div id="scanOverlay" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-md p-4 relative">
      <button id="closeScan" class="absolute right-3 top-3 text-slate-400">✕</button>
      <div class="mb-2 text-sm text-slate-600">เล็งกล้องไปที่บาร์โค้ด</div>
      <!-- สำคัญมากสำหรับ iPhone: muted + playsinline -->
      <video id="video" autoplay playsinline muted class="w-full rounded-lg bg-black"></video>
      <canvas id="canvas" class="hidden"></canvas>
      <div class="text-xs text-slate-500 mt-2">ถ้าอุปกรณ์ไม่รองรับ จะใช้ jsQR/Quagga ให้อัตโนมัติ</div>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwrKgKw0JFqwQX4-0sL90paBc4BLDPOiQyyWEUOx9MTetLfiUlabG1y6igSa-91RD-L/exec";

    // ===== Utils =====
    function digitsOnly(s){ return String(s ?? '').replace(/\D+/g,''); }
    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
    function escapeAttr(s){ return String(s).replace(/'/g,'&#39;'); }

    // ตัด "ตำแหน่งที่ 5–11 จากซ้าย" (1-based) แบบตายตัวเสมอ (และเก็บเฉพาะตัวเลขก่อน)
    function normalizeCode(raw) {
      const s = digitsOnly(raw).trim();
      return (s.length >= 11) ? s.slice(4, 11) : s;
    }

    // ===== Percent Formatter =====
    function formatPercent(value) {
      if (value == null || value === '') return '';
      let s = String(value).trim();
      const hasPercent = s.includes('%');
      const num = parseFloat(s.replace(/[^\d.\-]/g, ''));
      if (Number.isNaN(num)) return s;
      let pct = hasPercent ? num : (num <= 1 ? num * 100 : num);
      const r = Math.round(pct * 100) / 100;
      return (Number.isInteger(r) ? r.toString() : r.toFixed(2)) + '%';
    }

    // ===== History =====
    const LS_KEY_HIST = 'lookup_history_v2';
    const getHist = () => JSON.parse(localStorage.getItem(LS_KEY_HIST) || '[]');
    const setHist = (arr) => localStorage.setItem(LS_KEY_HIST, JSON.stringify(arr.slice(0,50)));
    function renderHist(){
      const ul = document.getElementById('histList');
      const hist = getHist();
      ul.innerHTML = hist.map(({code, description}) =>
        `<li><button class="underline" onclick="quickSearch('${escapeAttr(code)}')">${escapeHtml(code)}${description ? ' — ' + escapeHtml(description) : ''}</button></li>`
      ).join('') || '<li class="text-slate-400">— ไม่มี —</li>';
    }
    function addHist(entry){
      const e = { code: entry.code || '', description: entry.description || '' };
      if (!e.code) return;
      const hist = getHist();
      const idx = hist.findIndex(x => (x.code || '').toLowerCase() === e.code.toLowerCase());
      if (idx !== -1) hist.splice(idx,1);
      hist.unshift(e);
      setHist(hist);
      renderHist();
    }

    // ===== UI Builders =====
    function buildCard(d) {
      const code = d.CODE || '';
      const desc = d.DESCRIPTION || '';
      const cate = d.CATEGORY || '';
      const promo = formatPercent(d['PROMOTION(CF)']);
      const promoCode = d['PROMO CODE'] || '';
      return `
        <div class="glass rounded-2xl p-5 shadow-lg border border-white/50">
          <div class="grid grid-cols-1 gap-3">
            <div><div class="text-xs uppercase tracking-wide text-slate-500">CODE</div><div class="text-lg font-semibold">${escapeHtml(code)}</div></div>
            <div><div class="text-xs uppercase tracking-wide text-slate-500">DESCRIPTION</div><div class="text-base">${escapeHtml(desc)}</div></div>
            <div><div class="text-xs uppercase tracking-wide text-slate-500">CATEGORY</div><div class="text-base">${escapeHtml(cate)}</div></div>
            <div><div class="text-xs uppercase tracking-wide text-slate-500">PROMOTION(CF)</div><div class="text-base">${escapeHtml(promo)}</div></div>
            <div><div class="text-xs uppercase tracking-wide text-slate-500">PROMO CODE</div><div class="text-base">${escapeHtml(promoCode)}</div></div>
          </div>
        </div>`;
    }
    function showLoading(){
      document.getElementById('result').innerHTML = `
        <div class="glass rounded-2xl p-5 shadow-lg border border-white/50 animate-pulse">
          <div class="h-4 bg-slate-200 rounded w-24 mb-4"></div>
          <div class="space-y-3">
            <div class="h-6 bg-slate-200 rounded"></div>
            <div class="h-6 bg-slate-200 rounded"></div>
            <div class="h-6 bg-slate-200 rounded"></div>
            <div class="h-6 bg-slate-200 rounded"></div>
          </div>
        </div>`;
    }
    function showEmpty(msg='ไม่พบข้อมูล หรือ CODE นี้ไม่ร่วม PRO Clearance'){
      document.getElementById('result').innerHTML = `<div class="text-center text-slate-500">${msg}</div>`;
    }

    async function search(q){
      const code = normalizeCode(q);
      if (!code) { showEmpty('กรุณาพิมพ์ CODE'); return; }
      showLoading();
      try{
        const url = new URL(API_URL);
        url.searchParams.set('q', code);
        const res = await fetch(url.toString(), { cache: 'no-store' });
        const json = await res.json();
        if (json && json.data) {
          const d = json.data;
          document.getElementById('result').innerHTML = buildCard(d);
          addHist({ code: d.CODE || '', description: d.DESCRIPTION || '' });
        } else {
          showEmpty();
        }
      } catch(e){
        console.error(e);
        showEmpty('เกิดข้อผิดพลาดในการดึงข้อมูล');
      }
    }

    // ===== Elements & helpers =====
    const qInput   = document.getElementById('q');
    const btnSearch= document.getElementById('btn');
    const btnClear = document.getElementById('clear');

    function clearTextbox(focusBack=true, alsoResult=false){
      qInput.value = '';
      if (alsoResult) document.getElementById('result').innerHTML = '';
      if (focusBack) qInput.focus();
    }

    window.quickSearch = (c) => {
      clearTextbox(false);
      const code = normalizeCode(c);
      qInput.value = code;
      if (code.length === 7) search(code);
    };

    btnSearch.addEventListener('click', () => search(qInput.value));
    btnClear.addEventListener('click', () => clearTextbox(true, false));

    // keyboard wedge (debounced)
    let scanTimer = null;
    const SCAN_IDLE_MS = 120;
    qInput.addEventListener('input', () => {
      if (scanTimer) clearTimeout(scanTimer);
      scanTimer = setTimeout(() => {
        const code = normalizeCode(qInput.value);
        qInput.value = code;
        if (code.length === 7) search(code);
      }, SCAN_IDLE_MS);
    });
    qInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const code = normalizeCode(qInput.value);
        qInput.value = code;
        search(code);
      }
    });

    document.getElementById('clearHist').addEventListener('click', () => {
      localStorage.removeItem(LS_KEY_HIST);
      renderHist();
    });

    // ===== Scanner (iPhone-safe) =====
    const scanBtn   = document.getElementById('scan');
    const overlay   = document.getElementById('scanOverlay');
    const closeScan = document.getElementById('closeScan');
    const video     = document.getElementById('video');
    const canvas    = document.getElementById('canvas');
    const ctx       = canvas.getContext('2d', { willReadFrequently: true });

    let stream = null;
    let quaggaStarted = false;
    let jsqrActive = false;

    function onDetectedRaw(raw){
      clearTextbox(false);
      const code = normalizeCode(raw);
      stopScan();
      qInput.value = code;
      if (code.length === 7) search(code);
    }

    async function startNativeDetector(){
      const BarcodeDetectorClass = window.BarcodeDetector;
      if (!BarcodeDetectorClass) return false; // iPhone ส่วนใหญ่จะมาทางนี้

      const formats = ['ean_13','ean_8','code_128','code_39','upc_e','upc_a','itf','qr_code'];
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          audio: false,
          video: { facingMode: { ideal: 'environment' } }
        });
        video.srcObject = stream;
        video.muted = true;
        await video.play();

        const detector = new BarcodeDetectorClass({ formats });

        const scan = async () => {
          if (overlay.classList.contains('hidden')) return;

          try {
            // บางเบราว์เซอร์ไม่มี createImageBitmap → ใช้ canvas แทน
            let codes = [];
            if ('createImageBitmap' in window) {
              const bmp = await createImageBitmap(video);
              codes = await detector.detect(bmp);
            } else {
              const w = video.videoWidth, h = video.videoHeight;
              if (w && h) {
                canvas.width = w; canvas.height = h;
                ctx.drawImage(video, 0, 0, w, h);
                codes = await detector.detect(canvas);
              }
            }
            if (codes && codes.length) {
              const raw = codes[0]?.rawValue || '';
              if (raw) return onDetectedRaw(raw);
            }
          } catch(e){ /* ignore frame errors */ }

          requestAnimationFrame(scan);
        };
        requestAnimationFrame(scan);
        return true;
      } catch(e){
        console.warn('Native detector failed:', e);
        return false;
      }
    }

    async function startJsQR(){ // ใช้ได้ดีบน iPhone/Safari
      if (typeof jsQR === 'undefined') return false;
      try{
        stream = await navigator.mediaDevices.getUserMedia({
          audio: false,
          video: { facingMode: { ideal: 'environment' } }
        });
        video.srcObject = stream;
        video.muted = true;
        await video.play();

        jsqrActive = true;

        const scan = () => {
          if (!jsqrActive || overlay.classList.contains('hidden')) return;

          const w = video.videoWidth, h = video.videoHeight;
          if (!w || !h) { requestAnimationFrame(scan); return; }

          canvas.width = w; canvas.height = h;
          ctx.drawImage(video, 0, 0, w, h);
          const imageData = ctx.getImageData(0, 0, w, h);
          const result = jsQR(imageData.data, w, h, { inversionAttempts: "dontInvert" });
          if (result && result.data) {
            onDetectedRaw(result.data);
            return;
          }
          requestAnimationFrame(scan);
        };
        requestAnimationFrame(scan);
        return true;
      } catch(e){
        console.warn('jsQR failed:', e);
        return false;
      }
    }

    function startQuagga(){ // 1D barcode fallback (ไม่รองรับ QR)
      if (!window.Quagga) return false;
      Quagga.init({
        inputStream: { type: 'LiveStream', target: video, constraints: { facingMode: 'environment' } },
        decoder: { readers: ['ean_reader','ean_8_reader','code_128_reader','code_39_reader','upc_reader','upc_e_reader','itf_reader'] }
      }, function(err){
        if (err) { console.error(err); return; }
        Quagga.start(); quaggaStarted = true;
      });
      Quagga.onDetected(function(result){
        const raw = result?.codeResult?.code ?? '';
        if (raw) onDetectedRaw(raw);
      });
      return true;
    }

    function stopScan(){
      overlay.classList.add('hidden');
      jsqrActive = false;
      if (quaggaStarted && window.Quagga) { Quagga.stop(); quaggaStarted = false; }
      if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
      video.srcObject = null;
    }

    scanBtn.addEventListener('click', async () => {
      clearTextbox(true, false); // เริ่มสแกนใหม่ → เคลียร์ช่องก่อน
      overlay.classList.remove('hidden');

      // ลำดับ fallback: Native → jsQR (iPhone) → Quagga (1D)
      const okNative = await startNativeDetector();
      if (!okNative) {
        const okJs = await startJsQR();
        if (!okJs) startQuagga();
      }
    });
    closeScan.addEventListener('click', stopScan);

    // init
    renderHist();
  </script>
</body>
</html>

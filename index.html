<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Product Lookup – CODE Search</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Fallback สำหรับสแกนบนเครื่องที่ไม่มี BarcodeDetector -->
  <script defer src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
  <style>
    .glass { background: rgba(255,255,255,0.65); backdrop-filter: blur(10px); }
    .focus-ring:focus { outline: none; box-shadow: 0 0 0 4px rgba(37,99,235,0.25); }
    .shine { position: relative; overflow: hidden; }
    .shine::after { content: ""; position: absolute; top:0; left:-150%; width:50%; height:100%; transform: skewX(-20deg); background: linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent); animation: slide 2s ease-in-out infinite; }
    @keyframes slide { 0% { left: -150%; } 60% { left: 200%; } 100% { left: 200%; } }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-100 to-slate-200 text-slate-800">
  <div class="max-w-xl mx-auto px-4 py-8">
    <header class="mb-6">
      <h1 class="text-2xl font-semibold tracking-tight">Product Lookup</h1>
      <p class="text-sm text-slate-500">ค้นหาด้วยรหัสสินค้า (CODE)</p>
    </header>

    <div class="glass rounded-2xl p-4 shadow-lg border border-white/50">
      <div class="flex gap-2">
        <input id="q" type="text" inputmode="text" autocomplete="off"
               placeholder="พิมพ์/สแกน CODE แล้วกด Enter หรือปุ่มค้นหา"
               class="w-full px-4 py-3 rounded-xl border border-slate-200 focus-ring text-base" />
        <button id="clear" class="px-3 py-3 rounded-xl bg-white border border-slate-200 hover:bg-slate-50 active:scale-[.98] transition" title="ล้างค่า">ล้าง</button>
        <button id="scan" class="px-3 py-3 rounded-xl bg-white border border-slate-200 hover:bg-slate-50 active:scale-[.98] transition" title="สแกนบาร์โค้ด">สแกน</button>
        <button id="btn"  class="px-4 py-3 rounded-xl bg-black text-white hover:opacity-90 active:scale-[.98] transition shine">ค้นหา</button>
      </div>
      <div class="mt-2 text-xs text-slate-500">รองรับ Handheld/Tablet, การยิงบาร์โค้ด และกล้อง (ต้องเปิดผ่าน HTTPS)</div>
    </div>

    <section id="result" class="mt-6"></section>

    <section class="mt-6 grid gap-4">
      <div class="glass rounded-2xl p-4 shadow border border-white/50">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold">ประวัติการค้นหา</h2>
          <button id="clearHist" class="text-xs text-slate-500 underline">ล้างประวัติ</button>
        </div>
        <ul id="histList" class="mt-3 space-y-2 text-sm"></ul>
      </div>
    </section>
  </div>

  <!-- Scan overlay -->
  <div id="scanOverlay" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-md p-4 relative">
      <button id="closeScan" class="absolute right-3 top-3 text-slate-400">✕</button>
      <div class="mb-2 text-sm text-slate-600">เล็งกล้องไปที่บาร์โค้ด</div>
      <video id="video" autoplay playsinline class="w-full rounded-lg bg-black"></video>
      <canvas id="canvas" class="hidden"></canvas>
      <div class="text-xs text-slate-500 mt-2">ถ้ากล้องไม่รองรับ จะใช้ QuaggaJS อัตโนมัติ</div>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzBpyf1RHNqfkQ9-ejhT7GCv78VIJCLYCgRDBTtK8_JYlBSNxjKizDjWMxEQM9Le_Fj/exec";

    // ===== Percent Formatter =====
    function formatPercent(value) {
      if (value == null || value === '') return '';
      let s = String(value).trim();
      const hasPercent = s.includes('%');
      const num = parseFloat(s.replace(/[^\d.\-]/g, ''));
      if (Number.isNaN(num)) return s;
      let pct = hasPercent ? num : (num <= 1 ? num * 100 : num);
      const r = Math.round(pct * 100) / 100;
      return (Number.isInteger(r) ? r.toString() : r.toFixed(2)) + '%';
    }

    // ===== Local Storage (History: CODE + DESCRIPTION) =====
    const LS_KEY_HIST = 'lookup_history_v2';
    const getHist = () => JSON.parse(localStorage.getItem(LS_KEY_HIST) || '[]');
    const setHist = (arr) => localStorage.setItem(LS_KEY_HIST, JSON.stringify(arr.slice(0,50)));

    function renderHist(){
      const ul = document.getElementById('histList');
      const hist = getHist();
      ul.innerHTML = hist.map(({code, description}) =>
        `<li><button class="underline" onclick="quickSearch('${escapeAttr(code)}')">${escapeHtml(code)}${description ? ' — ' + escapeHtml(description) : ''}</button></li>`
      ).join('') || '<li class="text-slate-400">— ไม่มี —</li>';
    }

    function addHist(entry){
      const e = { code: entry.code || '', description: entry.description || '' };
      if (!e.code) return;
      const hist = getHist();
      const idx = hist.findIndex(x => (x.code || '').toLowerCase() === e.code.toLowerCase());
      if (idx !== -1) hist.splice(idx,1);
      hist.unshift(e);
      setHist(hist);
      renderHist();
    }

    // ===== Utilities =====
    function escapeHtml(s) {
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }
    function escapeAttr(s) { return String(s).replace(/'/g, '&#39;'); }

    // ====== ตัด "ตำแหน่งที่ 5–11 จากซ้าย" (1-based) แบบตายตัว ======
    // ใช้ทุกจุด: ปุ่มค้นหา/Enter, BarcodeDetector, Quagga, keyboard wedge
    function normalizeCode(raw) {
      const s = String(raw || '').trim();
      if (s.length >= 11) {
        return s.slice(4, 11); // index 4..10 => 7 อักขระ (ตำแหน่ง 5..11)
      }
      return s;
    }

    // ===== UI Builders =====
    function buildCard(d) {
      const code = d.CODE || '';
      const desc = d.DESCRIPTION || '';
      const promo = formatPercent(d['PROMOTION(CF)']);
      const promoCode = d['PROMO CODE'] || '';

      return `
        <div class="glass rounded-2xl p-5 shadow-lg border border-white/50">
          <div class="grid grid-cols-1 gap-3">
            <div><div class="text-xs uppercase tracking-wide text-slate-500">CODE</div><div class="text-lg font-semibold">${escapeHtml(code)}</div></div>
            <div><div class="text-xs uppercase tracking-wide text-slate-500">DESCRIPTION</div><div class="text-base">${escapeHtml(desc)}</div></div>
            <div><div class="text-xs uppercase tracking-wide text-slate-500">PROMOTION(CF)</div><div class="text-base">${escapeHtml(promo)}</div></div>
            <div><div class="text-xs uppercase tracking-wide text-slate-500">PROMO CODE</div><div class="text-base">${escapeHtml(promoCode)}</div></div>
          </div>
        </div>`;
    }

    function showLoading() {
      document.getElementById('result').innerHTML = `
        <div class="glass rounded-2xl p-5 shadow-lg border border-white/50 animate-pulse">
          <div class="h-4 bg-slate-200 rounded w-24 mb-4"></div>
          <div class="space-y-3">
            <div class="h-6 bg-slate-200 rounded"></div>
            <div class="h-6 bg-slate-200 rounded"></div>
            <div class="h-6 bg-slate-200 rounded"></div>
            <div class="h-6 bg-slate-200 rounded"></div>
          </div>
        </div>`;
    }

    function showEmpty(msg='ไม่พบข้อมูล หรือ CODE นี้ไม่ร่วม PRO Clearance') {
      document.getElementById('result').innerHTML = `<div class="text-center text-slate-500">${msg}</div>`;
    }

    async function search(q) {
      const code = normalizeCode(q);
      if (!code) { showEmpty('กรุณาพิมพ์ CODE'); return; }
      showLoading();
      try {
        const url = new URL(API_URL);
        url.searchParams.set('q', code);
        const res = await fetch(url.toString(), { cache: 'no-store' });
        const json = await res.json();
        if (json && json.data) {
          const d = json.data;
          document.getElementById('result').innerHTML = buildCard(d);
          addHist({ code: d.CODE || '', description: d.DESCRIPTION || '' });
        } else {
          showEmpty();
        }
      } catch (e) {
        console.error(e);
        showEmpty('เกิดข้อผิดพลาดในการดึงข้อมูล');
      }
    }

    // ====== Input / Buttons ======
    const qInput = document.getElementById('q');
    const btnSearch = document.getElementById('btn');
    const btnClear  = document.getElementById('clear');

    function clearTextbox(focusBack=true, alsoResult=false){
      qInput.value = '';
      if (alsoResult) document.getElementById('result').innerHTML = '';
      if (focusBack) qInput.focus();
    }

    window.quickSearch = (c) => {
      clearTextbox(false);
      const norm = normalizeCode(c);
      qInput.value = norm;
      // ถ้าเหลือ 7 หลักแล้ว ค้นหาให้เลย
      if (/^.{7}$/.test(norm)) search(norm);
    };

    btnSearch.addEventListener('click', () => search(qInput.value));
    qInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') search(e.target.value); });
    btnClear.addEventListener('click', () => clearTextbox(true, false));

    // รองรับเครื่องยิงเป็นคีย์บอร์ด (keyboard wedge): จะพิมพ์ยาวเข้ามาที่ช่อง #q
    // เมื่อเห็นความยาว >= 11 ให้ตัดทันทีเป็น 5..11 แล้ว auto-search ถ้ายาว 7 ตัว
    qInput.addEventListener('input', () => {
      const raw = qInput.value || '';
      if (raw.length >= 11) {
        const norm = normalizeCode(raw);
        if (norm !== raw) {
          qInput.value = norm;
        }
        if (norm.length === 7) search(norm);
      }
    });

    document.getElementById('clearHist').addEventListener('click', () => {
      localStorage.removeItem(LS_KEY_HIST);
      renderHist();
    });

    // ===== Barcode Scan (กล้อง/Quagga) =====
    const scanBtn = document.getElementById('scan');
    const overlay = document.getElementById('scanOverlay');
    const closeScan = document.getElementById('closeScan');
    const video = document.getElementById('video');
    let stream = null;
    let quaggaStarted = false;

    async function startNativeDetector(){
      const BarcodeDetectorClass = window.BarcodeDetector;
      if (!BarcodeDetectorClass) return false;
      const formats = ['ean_13','ean_8','code_128','code_39','upc_e','upc_a','itf','qr_code'];
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;
        video.play();

        const detector = new BarcodeDetectorClass({ formats });

        const scan = async () => {
          if (overlay.classList.contains('hidden')) return;
          try {
            const bitmap = await createImageBitmap(video);
            const codes = await detector.detect(bitmap);
            if (codes && codes.length) {
              const det  = codes[0];
              const raw  = det && det.rawValue ? String(det.rawValue) : '';
              // เคลียร์ช่องก่อนใส่ค่าใหม่ทุกครั้ง
              clearTextbox(false);
              const code = normalizeCode(raw);
              stopScan();
              qInput.value = code;
              if (code.length === 7) search(code);
            }
          } catch (e) {/* ignore frame errors */}
          requestAnimationFrame(scan);
        };
        requestAnimationFrame(scan);
        return true;
      } catch (e) { return false; }
    }

    function startQuagga(){
      if (!window.Quagga) return false;
      Quagga.init({
        inputStream: { type: 'LiveStream', target: video, constraints: { facingMode: 'environment' } },
        decoder: { readers: ['ean_reader','ean_8_reader','code_128_reader','code_39_reader','upc_reader','upc_e_reader','itf_reader','qr_reader'] }
      }, function(err){
        if (err) { console.error(err); return; }
        Quagga.start();
        quaggaStarted = true;
      });
      Quagga.onDetected(function(result){
        const raw = result?.codeResult?.code || '';
        // เคลียร์ช่องก่อนใส่ค่าใหม่ทุกครั้ง
        clearTextbox(false);
        const code = normalizeCode(raw);
        if (code) {
          stopScan();
          qInput.value = code;
          if (code.length === 7) search(code);
        }
      });
      return true;
    }

    function stopScan(){
      overlay.classList.add('hidden');
      if (quaggaStarted && window.Quagga) { Quagga.stop(); quaggaStarted = false; }
      if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
      video.srcObject = null;
    }

    scanBtn.addEventListener('click', async () => {
      // เริ่มสแกนใหม่ → เคลียร์ช่องก่อน
      clearTextbox(true, false);
      overlay.classList.remove('hidden');
      const ok = await startNativeDetector();
      if (!ok) startQuagga();
    });
    closeScan.addEventListener('click', stopScan);

    // init
    renderHist();
  </script>
</body>
</html>

